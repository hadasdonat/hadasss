<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Mood Matcher</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.1/css/all.min.css" 
    integrity="sha512-5Hs3dF2AEPkpNAR7UiOHba+lRSJNeM2ECkwxUIxC1Q/FLycGTbNapWXB4tP889k5T5Ju8fs4b1P5z/iB4nMfSQ==" 
    crossorigin="anonymous" referrerpolicy="no-referrer">
</head>

<body>

    <div class="container">
        <header>
            <h1>Movie Mood Matcher</h1>
            <p>Find the perfect movie for your mood with our technology!</p>
        </header>
        <main>
            <!-- Genre Selection Section -->
            <div id="genre-selection">
                <h2>Choose up to 5 genres for a more tailored match:</h2>
                
                <form id="genre-form">
                    <label><input type="checkbox" name="genre" value="Drama"> Drama</label>
                    <label><input type="checkbox" name="genre" value="Action"> Action</label>
                    <label><input type="checkbox" name="genre" value="Fantasy"> Fantasy</label>
                    <label><input type="checkbox" name="genre" value="Horror"> Horror</label>
                    <label><input type="checkbox" name="genre" value="Thriller"> Thriller</label>
                    <label><input type="checkbox" name="genre" value="Romance"> Romance</label>
                    <label><input type="checkbox" name="genre" value="Biography"> Biography</label>
                    <label><input type="checkbox" name="genre" value="Comedy"> Comedy</label>
                </form>
                <small>You can select up to 5 preferences</small>
            </div>

            <!-- Image Upload Section -->
            <div id="upload-section">
                <button id="upload-btn" onclick="triggerUpload()">Upload / Take a Picture</button>
                <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
            </div>

            <!-- Loading Spinner -->
            <div id="loading-spinner" style="display: none;">Loading...</div>
             <!-- מסך הביניים (רגשות) -->
            <div id="emotions-section" style="display: none;">
                <h2>Detected Emotions</h2>
                <div id="emotions-container">
                    <p>🔄 Analyzing emotions... Please wait.</p>
                </div>
                <button id="continue-btn" onclick="showMovieResult()">Show My Movie Match</button>
            </div>


            <!-- Result Section -->
            <div id="result-section" style="display: none;">
                <!-- Movie 1 -->
                <div class="movie-card" id="movie-card-1" style="display: none;">
                    <div id="movie-name-1">
                        <i class="fas fa-popcorn"></i>
                        Movie Title 1
                    </div>
                    <a id="movie-link-1" href="#" target="_blank">More about this movie</a>
                </div>

                <!-- Movie 2 -->
                <div class="movie-card" id="movie-card-2" style="display: none;">
                    <div id="movie-name-2">
                        <i class="fas fa-film"></i>
                        Movie Title 2
                    </div>
                    <a id="movie-link-2" href="#" target="_blank">More about this movie</a>
                </div>

                <div id="enjoy-text">!צפייה מהנה</div>
            </div>
        </main>
        <footer>
            <p>Powered by AI, our team, and your mood! ©️ 2024</p>
        </footer>
    </div>

<script>
 console.log("✅ קובץ ה-JavaScript נטען!");

 function triggerUpload() {
    console.log("✅ `triggerUpload()` מופעל!");
    let input = document.getElementById("file-input");

    if (!input) {
        console.error("❌ אין `file-input`!");
        return;
    }

    console.log("📌 `file-input` נמצא, מסיר `display: none;` זמנית...");
    
    // 1️⃣ הופך את האלמנט לגלוי
    input.style.display = "block";  
    input.style.opacity = "0";  // שומר עליו מוסתר מבחינת המשתמש אבל פעיל
    
    // 2️⃣ מבצע קליק
    input.click();

    // 3️⃣ מחזיר אותו לנסתר אחרי שניה
    setTimeout(() => {
        input.style.display = "none";
    }, 100);
}


let emotionsResult = null; // משתנה גלובלי לאחסון תוצאות הרגשות

async function handleFileUpload(event) {
    console.log("✅ handleFileUpload() התחילה לעבוד"); // בדיקה שהפונקציה מופעלת

    const file = event.target.files[0];
    if (!file) return;

    console.log("✅ קובץ נבחר:", file.name); // בדיקה שהקובץ אכן נקלט

    const selectedGenres = Array.from(document.querySelectorAll('#genre-form input[name="genre"]:checked'))
        .map(checkbox => checkbox.value);

    // 🔹 הצגת מסך הביניים **מיד**
    document.getElementById('upload-section').style.display = 'none';
    document.getElementById('genre-selection').style.display = 'none';
    document.getElementById('emotions-section').style.display = 'block';

    console.log("✅ מסך הביניים מוצג!"); // בדיקה

    // הצגת הודעה זמנית עד שהשרת מחזיר נתונים
    document.getElementById('emotions-container').innerHTML = `<p>🔄 Analyzing emotions... Please wait.</p>`;

    try {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('topGeneresJson', JSON.stringify(selectedGenres));

        console.log("📡 שולח תמונה לשרת...");
        const emotionsResponse = await fetch('/movies/emotions', {
            method: 'POST',
            body: formData
        });

        console.log("📡 קיבלתי תשובה מהשרת!");
        emotionsResult = await emotionsResponse.json();
        console.log("📡 תגובת השרת:", emotionsResult);

        // 🔹 עדכון מסך הביניים עם הרגשות שהגיעו מהשרת
        showEmotions(emotionsResult.emotions);

    } catch (error) {
        console.error("❌ Error:", error);
        alert("Failed to analyze image. Please try again.");
        document.getElementById('emotions-section').style.display = 'none';
        document.getElementById('upload-section').style.display = 'block';
        document.getElementById('genre-selection').style.display = 'block';
    }
}



function showEmotions(emotions) {
    if (!emotions) {
        console.error("Error: No emotions data received.");
        return;
    }

    console.log("showEmotions activated", emotions);

    const container = document.getElementById('emotions-container');
    container.innerHTML = ''; // מנקים את ההודעה הקודמת

    Object.entries(emotions).forEach(([emotion, value]) => {
        const percentage = (value * 100).toFixed(1);
        const emotionDiv = document.createElement('div');
        emotionDiv.className = 'emotion-item';
        emotionDiv.innerHTML = `
            <span>${emotion}</span>
            <div class="emotion-bar">
                <div class="emotion-fill" style="width: ${percentage}%"></div>
            </div>
            <span>${percentage}%</span>
        `;
        container.appendChild(emotionDiv);
    });

    // מסך הרגשות כבר פתוח – אז פשוט מעדכנים אותו
}

async function showMovieResult() {
    if (!emotionsResult || !emotionsResult.emotions) {
        console.error("🚨 Error: emotionsResult is not defined yet.");
        alert("Emotions data is not available yet. Please upload an image first.");
        return;
    }

    console.log("✅ Button clicked! Fetching recommended movie...");
    document.getElementById('emotions-section').style.display = 'none';
    document.getElementById('loading-spinner').style.display = 'block';

    const fileInput = document.getElementById('file-input');
    const file = fileInput.files[0];

    if (!file) {
        console.error("❌ No image file found in file-input.");
        alert("Error: No image found. Please upload a new image.");
        return;
    }

    const selectedGenres = Array.from(document.querySelectorAll('#genre-form input[name="genre"]:checked'))
        .map(checkbox => checkbox.value);

    console.log("📌 Debug: Selected genres:", selectedGenres);

    try {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('emotions', JSON.stringify(emotionsResult.emotions));
        formData.append('gender', emotionsResult.gender || "");
        formData.append('genres', JSON.stringify(selectedGenres)); // 🆕 הוספת הז'אנרים

        console.log("📡 שולח בקשה לשרת עם הנתונים:", { file, emotions: emotionsResult.emotions, genres: selectedGenres });

        const response = await fetch('/movies/recommendations', {
            method: 'POST',
            body: formData
        });

        const responseText = await response.text(); // בדיקה שהתגובה תקינה
        console.log("📡 תגובת השרת בפורמט טקסט:", responseText);

        if (!response.ok) {
            throw new Error(`שגיאת שרת (${response.status}): ${responseText}`);
        }

        const result = JSON.parse(responseText);
        console.log("📡 JSON תקין מהשרת:", result);

        document.getElementById('loading-spinner').style.display = 'none';
        document.getElementById('result-section').style.display = 'block';

        // ניקוי התוצאות הקודמות
        document.getElementById('movie-card-1').style.display = 'none';
        document.getElementById('movie-card-2').style.display = 'none';

        if (result.length > 0 && result[0].title) {
            document.getElementById('movie-card-1').style.display = 'block';
            document.getElementById('movie-name-1').textContent = result[0].title;
            document.getElementById('movie-link-1').href = result[0].link;
        }

        if (result.length > 1 && result[1].title) {
            document.getElementById('movie-card-2').style.display = 'block';
            document.getElementById('movie-name-2').textContent = result[1].title;
            document.getElementById('movie-link-2').href = result[1].link;
        }

    } catch (error) {
        console.error("❌ Error fetching movie recommendation:", error);
        alert("Failed to get movie recommendation.");
        document.getElementById('loading-spinner').style.display = 'none';
    }
}




// async function handleFileUpload(event) {
//     const file = event.target.files[0];
//     if (file) {
//         // Validate genre selection
//         const selectedGenres = Array.from(document.querySelectorAll('#genre-form input[name="genre"]:checked')).map(checkbox => checkbox.value);
//         if (selectedGenres.length > 5) {
//             alert('You can select up to 5 genres only.');
//             return;
//         }

//         if (selectedGenres.length === 0) {
//             alert('No genres selected. Proceeding without genres.');
//         }

//         // Show loading spinner
//         document.getElementById('loading-spinner').style.display = 'block';
//         document.
// getElementById('upload-section').style.display = 'none';
//         document.getElementById('genre-selection').style.display = 'none';

//         try {
//             // Create form data to send
//             const formData = new FormData();
//             formData.append('image', file);
//             formData.append('topGeneresJson', JSON.stringify(selectedGenres));

//             const response = await fetch('/movies/recommendations', {
//                 method: 'POST',
//                 body: formData
//             });

//             // Read the server response
//             const result = await response.json();
//             console.log(result);

//             // Update results on the screen
//             document.getElementById('loading-spinner').style.display = 'none';
//             document.getElementById('result-section').style.display = 'block';

//             // Update Movie 1 details
//             if (result[0]) {
//                 document.getElementById('movie-card-1').style.display = 'block';
//                 document.getElementById('movie-name-1').textContent = result[0].title || 'Unknown Movie';
//                 document.getElementById('movie-link-1').href = result[0].link || '#';
//             }

//             // Update Movie 2 details
//             if (result[1]) {
//                 document.getElementById('movie-card-2').style.display = 'block';
//                 document.getElementById('movie-name-2').textContent = result[1].title || 'Unknown Movie';
//                 document.getElementById('movie-link-2').href = result[1].link || '#';
//             }
//         } catch (error) {
//             console.error('Error:', error);
//             alert('Failed to analyze image. Please try again.');
//             document.getElementById('loading-spinner').style.display = 'none';
//             document.getElementById('upload-section').style.display = 'block';
//             document.getElementById('genre-selection').style.display = 'block';
//         }
//     }
// }
document.addEventListener("DOMContentLoaded", function() {
         console.log("✅ הסקריפט נטען לאחר שה-HTML סיים להיטען!");
        console.log("📌 האם emotions-section קיים?", document.getElementById("emotions-section"));
    });
 </script>
</body>
</html>
